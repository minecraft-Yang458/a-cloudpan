<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>混合网盘系统</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { margin-bottom: 10px; }
    .file-list { margin-top: 20px; }
    .file-item { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>混合储存网盘</h1>

  <div>
    <input type="file" id="fileInput">
    <select id="uploadType">
      <option value="dropbox">Dropbox</option>
      <option value="gdrive">Google Drive</option>
    </select>
    <button onclick="uploadFile()">上传</button>
  </div>

  <div class="file-list">
    <h2>文件列表</h2>
    <button onclick="loadFiles()">刷新</button>
    <ul id="fileList"></ul>
  </div>

  <script>
    const API_BASE = "/api"; // Worker 路由前缀

    async function uploadFile() {
      const fileInput = document.getElementById("fileInput");
      if (fileInput.files.length === 0) {
        alert("请选择文件");
        return;
      }

      const file = fileInput.files[0];
      const uploadType = document.getElementById("uploadType").value;

      // >5GB 文件需要校验码
      if (file.size > 5 * 1024 * 1024 * 1024) {
        const code = prompt("请输入大文件校验码");
        if (!code) {
          alert("必须输入校验码");
          return;
        }

        const form = new FormData();
        form.append("filename", file.name);
        form.append("size", file.size);
        form.append("code", code);
        form.append("upload_type", uploadType);

        const res = await fetch(`${API_BASE}/upload`, { method: "POST", body: form });
        const data = await res.json();
        if (res.ok && data.uploadUrl) {
          alert("请在控制台查看上传链接，自己用 fetch/工具上传：\n" + data.uploadUrl);
          console.log("大文件上传链接：", data.uploadUrl);
        } else {
          alert("校验失败或出错: " + JSON.stringify(data));
        }
        return;
      }

      // 小文件直接上传
      const form = new FormData();
      form.append("file", file);
      form.append("upload_type", uploadType);

      const res = await fetch(`${API_BASE}/upload`, { method: "POST", body: form });
      const data = await res.json();
      if (res.ok) {
        alert("上传成功！");
        loadFiles();
      } else {
        alert("上传失败: " + JSON.stringify(data));
      }
    }

    async function loadFiles() {
      const res = await fetch(`${API_BASE}/files`);
      const data = await res.json();
      const list = document.getElementById("fileList");
      list.innerHTML = "";

      data.files.forEach(f => {
        const li = document.createElement("li");
        li.className = "file-item";
        const sizeMB = (f.size / (1024*1024)).toFixed(2) + " MB";

        let downloadUrl = `${API_BASE}/download?file=${encodeURIComponent(f.source === "Google Drive" ? f.id : f.name)}&type=${f.source === "Google Drive" ? "gdrive" : "dropbox"}`;

        li.innerHTML = `${f.name} (${sizeMB}, ${f.source}) 
                        <a href="${downloadUrl}">下载</a>`;
        list.appendChild(li);
      });
    }

    loadFiles();
  </script>
</body>
</html>
